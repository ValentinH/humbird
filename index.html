<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>HumBird üê¶üéµ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1a1a2e;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 1rem;
    }
    h1 { font-size: 2rem; margin-bottom: 0.5rem; }
    .subtitle { color: #888; margin-bottom: 2rem; font-size: 0.9rem; }
    #start-btn {
      background: #e94560;
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-size: 1.2rem;
      cursor: pointer;
      transition: transform 0.1s;
    }
    #start-btn:active { transform: scale(0.95); }
    #start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    #note-display {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      margin-top: 2rem;
    }
    .current-note {
      font-size: 8rem;
      font-weight: bold;
      line-height: 1;
      transition: color 0.1s;
    }
    .note-info {
      display: flex;
      gap: 2rem;
      font-size: 1rem;
      color: #aaa;
    }
    .note-bar {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .note-bar span {
      padding: 0.5rem 0.75rem;
      border-radius: 8px;
      background: #16213e;
      font-weight: bold;
      font-size: 1.1rem;
      transition: background 0.15s, transform 0.15s;
    }
    .note-bar span.active {
      background: #e94560;
      transform: scale(1.2);
    }
    .cents {
      width: 200px;
      height: 6px;
      background: #16213e;
      border-radius: 3px;
      position: relative;
      overflow: hidden;
    }
    .cents-indicator {
      position: absolute;
      width: 8px;
      height: 100%;
      background: #0f3460;
      border-radius: 3px;
      left: 50%;
      transform: translateX(-50%);
      transition: left 0.08s, background 0.15s;
    }
    .cents-indicator.in-tune { background: #4ecca3; }
    #error { color: #e94560; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>üê¶üéµ HumBird</h1>
  <p class="subtitle">Sing to fly ‚Äî voice-controlled game</p>
  <button id="start-btn">üé§ Connect Microphone</button>
  <div id="error"></div>
  <div id="note-display">
    <div class="current-note" id="current-note">‚Äî</div>
    <div class="cents" id="cents-bar">
      <div class="cents-indicator" id="cents-indicator"></div>
    </div>
    <div class="note-info">
      <span>Freq: <strong id="freq">‚Äî</strong> Hz</span>
      <span>Cents: <strong id="cents">‚Äî</strong></span>
    </div>
    <div class="note-bar" id="note-bar">
      <span>C</span><span>D</span><span>E</span><span>F</span><span>G</span><span>A</span><span>B</span>
    </div>
  </div>

  <script>
    const NOTE_NAMES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
    const GAME_NOTES = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

    const startBtn = document.getElementById('start-btn');
    const noteDisplay = document.getElementById('note-display');
    const currentNoteEl = document.getElementById('current-note');
    const freqEl = document.getElementById('freq');
    const centsEl = document.getElementById('cents');
    const centsIndicator = document.getElementById('cents-indicator');
    const noteBarSpans = document.querySelectorAll('#note-bar span');
    const errorEl = document.getElementById('error');

    // Autocorrelation-based pitch detection
    function autoCorrelate(buf, sampleRate) {
      let size = buf.length;
      let rms = 0;
      for (let i = 0; i < size; i++) rms += buf[i] * buf[i];
      rms = Math.sqrt(rms / size);
      if (rms < 0.01) return -1; // too quiet

      // trim silence
      let r1 = 0, r2 = size - 1;
      const threshold = 0.2;
      for (let i = 0; i < size / 2; i++) { if (Math.abs(buf[i]) < threshold) { r1 = i; break; } }
      for (let i = 1; i < size / 2; i++) { if (Math.abs(buf[size - i]) < threshold) { r2 = size - i; break; } }

      buf = buf.slice(r1, r2);
      size = buf.length;

      const c = new Float32Array(size);
      for (let i = 0; i < size; i++) {
        for (let j = 0; j < size - i; j++) {
          c[i] += buf[j] * buf[j + i];
        }
      }

      let d = 0;
      while (c[d] > c[d + 1]) d++;

      let maxval = -1, maxpos = -1;
      for (let i = d; i < size; i++) {
        if (c[i] > maxval) { maxval = c[i]; maxpos = i; }
      }

      let T0 = maxpos;
      // parabolic interpolation
      const x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
      const a = (x1 + x3 - 2 * x2) / 2;
      const b = (x3 - x1) / 2;
      if (a) T0 = T0 - b / (2 * a);

      return sampleRate / T0;
    }

    function noteFromFreq(freq) {
      const noteNum = 12 * (Math.log2(freq / 440));
      return Math.round(noteNum) + 69;
    }

    function centsOffFromFreq(freq, noteNum) {
      return Math.floor(1200 * Math.log2(freq / (440 * Math.pow(2, (noteNum - 69) / 12))));
    }

    startBtn.addEventListener('click', async () => {
      try {
        startBtn.disabled = true;
        startBtn.textContent = 'üé§ Connecting...';
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioCtx = new AudioContext();
        const source = audioCtx.createMediaStreamSource(stream);
        const analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        source.connect(analyser);

        const buf = new Float32Array(analyser.fftSize);

        startBtn.style.display = 'none';
        noteDisplay.style.display = 'flex';

        function update() {
          analyser.getFloatTimeDomainData(buf);
          const freq = autoCorrelate(buf, audioCtx.sampleRate);

          if (freq === -1) {
            currentNoteEl.textContent = '‚Äî';
            currentNoteEl.style.color = '#555';
            freqEl.textContent = '‚Äî';
            centsEl.textContent = '‚Äî';
            centsIndicator.style.left = '50%';
            centsIndicator.classList.remove('in-tune');
            noteBarSpans.forEach(s => s.classList.remove('active'));
          } else {
            const midi = noteFromFreq(freq);
            const noteName = NOTE_NAMES[midi % 12];
            const cents = centsOffFromFreq(freq, midi);
            const inTune = Math.abs(cents) < 10;

            currentNoteEl.textContent = noteName;
            currentNoteEl.style.color = inTune ? '#4ecca3' : '#e94560';
            freqEl.textContent = freq.toFixed(1);
            centsEl.textContent = (cents > 0 ? '+' : '') + cents;

            const pct = 50 + (cents / 50) * 50;
            centsIndicator.style.left = Math.max(0, Math.min(100, pct)) + '%';
            centsIndicator.classList.toggle('in-tune', inTune);

            // Highlight in note bar (map sharps to nearest natural)
            const natural = noteName.replace('#', '');
            noteBarSpans.forEach(s => {
              s.classList.toggle('active', s.textContent === natural);
            });
          }

          requestAnimationFrame(update);
        }
        update();

      } catch (err) {
        startBtn.disabled = false;
        startBtn.textContent = 'üé§ Connect Microphone';
        errorEl.textContent = err.name === 'NotAllowedError'
          ? 'Microphone access denied. Please allow it and try again.'
          : 'Error: ' + err.message;
      }
    });
  </script>
</body>
</html>
